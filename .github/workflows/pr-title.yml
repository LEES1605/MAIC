# [01] START: .github/workflows/pr-title.yml
name: CI â€¢ PR Title (Conventional, auto-fix)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  workflow_dispatch:

jobs:
  pr-title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write

    steps:
      - name: Autofix PR title (Patch N / patch-N / Patch-N -> chore(patch-N): ...)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No PR context. Skipping autofix.");
              return;
            }
            const title = pr.title || "";

            // Patterns to normalize "Patch ..." titles into Conventional form.
            // e.g. "Patch 12", "Patch-12", "Patch 12: subject", "Patch-12 - subject"
            const patterns = [
              [/^patch\s*[-\s]?(\d+)\s*[:\-]?\s*(.*)$/i, (m) => {
                const num = m[1];
                const subj = (m[2] || "").trim() || "maintenance";
                return `chore(patch-${num}): ${subj}`;
              }],
            ];

            let newTitle = null;
            for (const [rx, fmt] of patterns) {
              const m = title.match(rx);
              if (m) { newTitle = fmt(m); break; }
            }

            if (newTitle && newTitle !== title) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: newTitle
              });
              core.info(`Updated PR title -> ${newTitle}`);
            } else {
              core.info("Title is not in a known 'Patch' pattern or already conventional. No change.");
            }

      - name: Validate PR title (Conventional Commits)
        if: ${{ github.event_name == 'pull_request' }}
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          validateSingleCommit: true

      - name: No-op for workflow_dispatch
        if: ${{ github.event_name != 'pull_request' }}
        run: echo "This workflow validates PR titles. Manual run is a no-op."
# [01] END: .github/workflows/pr-title.yml
