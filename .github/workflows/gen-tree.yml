# ========================== [01] 워크플로 메타 — START ==========================
name: CI • Generate TREE/INVENTORY
# PR에서만 실행 (main에 push될 때는 동작하지 않음)
on:
  pull_request:
    paths:
      - "**/*.py"
      - "scripts/gen_tree.py"
      - ".github/workflows/gen-tree.yml"
permissions:
  contents: write   # same-repo PR에서 생성물 자동 커밋
# ========================== [01] 워크플로 메타 — END ============================

# ========================== [02] TREE/INV 생성 — START =========================
jobs:
  gen-tree:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: 🧰 Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install deps
        run: |
          python -m pip install --upgrade pip

      - name: 🏗️ Generate files
        run: |
          set -euo pipefail
          mkdir -p docs/_gpt
          python scripts/gen_tree.py --out-dir docs/_gpt

      - name: ✅ Commit updated files (same-repo PR만)
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 둘 중 일부만 생성될 수도 있으므로 존재하는 것만 add
          test -f docs/_gpt/TREE.md && git add docs/_gpt/TREE.md || true
          test -f docs/_gpt/INVENTORY.json && git add docs/_gpt/INVENTORY.json || true
          if ! git diff --cached --quiet; then
            git commit -m "ci(gen-tree): update TREE/INVENTORY"
            git push
          else
            echo "No changes to commit."
          fi

      - name: 📝 Show diff (fork PR 등 자동커밋 불가)
        if: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        run: |
          echo "Changed files (not committed due to fork PR):"
          git status --porcelain || true
          git diff --stat || true
# ========================== [02] TREE/INV 생성 — END ===========================
