# ========================== [01] ì›Œí¬í”Œë¡œ ë©”íƒ€ â€” START ==========================
name: CI â€¢ Generate TREE/INVENTORY
# PRì—ì„œë§Œ ì‹¤í–‰ (mainì— pushë  ë•ŒëŠ” ë™ì‘í•˜ì§€ ì•ŠìŒ)
on:
  pull_request:
    paths:
      - "**/*.py"
      - "scripts/gen_tree.py"
      - ".github/workflows/gen-tree.yml"
permissions:
  contents: write   # same-repo PRì—ì„œ ìƒì„±ë¬¼ ìë™ ì»¤ë°‹
# ========================== [01] ì›Œí¬í”Œë¡œ ë©”íƒ€ â€” END ============================

# ========================== [02] TREE/INV ìƒì„± â€” START =========================
jobs:
  gen-tree:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§° Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install deps
        run: |
          python -m pip install --upgrade pip

      - name: ğŸ—ï¸ Generate files
        run: |
          set -euo pipefail
          mkdir -p docs/_gpt
          python scripts/gen_tree.py --out-dir docs/_gpt

      - name: âœ… Commit updated files (same-repo PRë§Œ)
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # ë‘˜ ì¤‘ ì¼ë¶€ë§Œ ìƒì„±ë  ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ add
          test -f docs/_gpt/TREE.md && git add docs/_gpt/TREE.md || true
          test -f docs/_gpt/INVENTORY.json && git add docs/_gpt/INVENTORY.json || true
          if ! git diff --cached --quiet; then
            git commit -m "ci(gen-tree): update TREE/INVENTORY"
            git push
          else
            echo "No changes to commit."
          fi

      - name: ğŸ“ Show diff (fork PR ë“± ìë™ì»¤ë°‹ ë¶ˆê°€)
        if: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        run: |
          echo "Changed files (not committed due to fork PR):"
          git status --porcelain || true
          git diff --stat || true
# ========================== [02] TREE/INV ìƒì„± â€” END ===========================
