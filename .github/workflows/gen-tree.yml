name: CI • Generate TREE/INVENTORY

on:
  pull_request:
    paths-ignore:
      - 'docs/_gpt/**'
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/_gpt/**'

# 중복 실행 자동 취소(최신 커밋만 유지)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  gen-tree:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      # ⛳️ PATCH-GUARD가 확인하는 앵커 (이 줄과 다음 run 라인은 꼭 유지)
      - name: Generate
        run: |
          python scripts/gen_tree.py --out-dir docs/_gpt

      # PR에서는 생성 산출물을 PR 브랜치에 자동 커밋
      - name: Auto-commit generated files (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -e
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add docs/_gpt/TREE.md docs/_gpt/INVENTORY.json || true
          if ! git diff --cached --quiet; then
            git commit -m "docs(_gpt): update TREE/INVENTORY (auto)"
            git push origin "HEAD:${{ github.head_ref }}"
          fi

      # main으로 push될 때는 변경 없음을 검증만
      - name: Verify clean (push to main)
        if: ${{ github.event_name == 'push' }}
        run: |
          git diff --exit-code -- docs/_gpt/TREE.md docs/_gpt/INVENTORY.json
