# ============================== [01] gen-tree.yml â€” START ===============================
name: CI â€¢ Docs Tree & Inventory

on:
  push:
    branches: ['**']
  pull_request:

# ìžë™ í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”
permissions:
  contents: write

concurrency:
  group: docs-tree-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-docs-tree:
    name: Build & Auto-commit TREE/INVENTORY
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: .
    steps:
      - name: ðŸ§° Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“ Ensure target folder exists
        run: |
          set -e
          mkdir -p docs/_gpt

      - name: ðŸ› ï¸ Generate TREE/INVENTORY
        run: |
          set -e
          # ê¸°ë³¸ ì œë„ˆë ˆì´í„°: scripts/gen_tree.py ê°€ ë¦¬í¬ íŠ¸ë¦¬ë¥¼ ìŠ¤ìº”í•´ ì‚°ì¶œë¬¼ì„ ë§Œë“­ë‹ˆë‹¤.
          # (ë¦¬í¬ì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ íŒŒì¼ ê²½ë¡œë¥¼ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•œë‹¤ë©´, ë‹¨ìˆœ í˜¸ì¶œë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.)
          python scripts/gen_tree.py
          # í˜¹ì‹œ ìŠ¤í¬ë¦½íŠ¸ê°€ ê²½ë¡œë¥¼ ë‹¤ë¥´ê²Œ ì“°ëŠ” ë¦¬í¬ë¼ë©´, ì•„ëž˜ì™€ ê°™ì´ ë³´ê°• ìƒì„±(ë¬´í•´)í•©ë‹ˆë‹¤.
          if [ ! -f docs/_gpt/TREE.md ]; then
            echo "# Repository Tree" > docs/_gpt/TREE.md
            echo "" >> docs/_gpt/TREE.md
            echo '```text' >> docs/_gpt/TREE.md
            git ls-files | sed 's/^/ - /' >> docs/_gpt/TREE.md
            echo '```' >> docs/_gpt/TREE.md
          fi
          if [ ! -f docs/_gpt/INVENTORY.json ]; then
            python - <<'PYCODE'
import json, os
files = [{"path": p} for p in os.popen("git ls-files").read().splitlines()]
with open("docs/_gpt/INVENTORY.json","w",encoding="utf-8") as f:
    json.dump({"files": files}, f, ensure_ascii=False, indent=2)
PYCODE
          fi

      - name: ðŸ“ Auto-commit generated Tree/Inventory
        # í¬í¬ PRì€ í‘¸ì‹œ ê¶Œí•œì´ ì—†ì–´ ì‹¤íŒ¨í•˜ë¯€ë¡œ ìŠ¤í‚µ
        if: |
          github.event_name == 'push' || (
            github.event_name == 'pull_request' &&
            github.event.pull_request.head.repo.full_name == github.repository
          )
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ë³€ê²½ëœ íŒŒì¼ë§Œ ìŠ¤í…Œì´ì§•
          git add docs/_gpt/TREE.md docs/_gpt/INVENTORY.json || true

          # ì»¤ë°‹ í•„ìš” ì—†ìœ¼ë©´ ì¡°ìš©ížˆ í†µê³¼
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "docs: auto-update TREE/INVENTORY [skip ci]"
          git push

      - name: ðŸ” Verify clean working tree
        # í¬í¬ PRì—ì„œëŠ” ìžë™ ì»¤ë°‹ì„ í•˜ì§€ ì•Šìœ¼ë‹ˆ, ê²€ì¦ì€ ì •ë³´ ì¶œë ¥ë§Œ í•˜ê³  ì‹¤íŒ¨í•˜ì§€ ì•Šê²Œ ì²˜ë¦¬
        run: |
          set -e
          if ! git diff --quiet; then
            echo "::warning::Working tree not clean (this can happen on forked PRs without push perms)."
            git status --porcelain || true
            git diff --name-only || true
          else
            echo "Working tree is clean."
          fi
# ============================== [01] gen-tree.yml â€” END =================================
