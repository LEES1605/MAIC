# [01] START: .github/workflows/publish-prompts.yml — 입력/폴백→업로드→자산검증(전체 교체)
name: publish-prompts

on:
  workflow_dispatch:
    inputs:
      prompts_yaml:
        description: "Prompts YAML contents (multiline)."
        required: false
  repository_dispatch:
    types: [publish-prompts]

permissions:
  contents: write

jobs:
  publish:
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install jq & gh
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          gh --version || true

      - name: Prepare prompts.yaml (inputs > client_payload > SSOT fallback)
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          OUT="${RUNNER_TEMP}/prompts.yaml"
          HAVE=""

          # 1) repository_dispatch → client_payload.prompts_yaml
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            RAW='${{ toJSON(github.event.client_payload.prompts_yaml) }}'
            if [[ "$RAW" != "null" && -n "$RAW" ]]; then
              printf '%s' "$RAW" | jq -r '.' > "$OUT"; HAVE=1
            fi
          fi

          # 2) workflow_dispatch → inputs.prompts_yaml
          if [[ -z "${HAVE}" ]]; then
            RAW='${{ toJSON(github.event.inputs.prompts_yaml) }}'
            if [[ "$RAW" != "null" && -n "$RAW" ]]; then
              printf '%s' "$RAW" | jq -r '.' > "$OUT"; HAVE=1
            fi
          fi

          # 3) SSOT fallback
          if [[ -z "${HAVE}" ]]; then
            if [[ -f docs/_gpt/prompts.yaml ]]; then
              cp docs/_gpt/prompts.yaml "$OUT"; HAVE=1
            elif [[ -f docs/_gpt/prompts.sample.yaml ]]; then
              cp docs/_gpt/prompts.sample.yaml "$OUT"; HAVE=1
            fi
          fi

          if [[ -z "${HAVE}" ]]; then
            echo "No prompts provided and no fallback found." >&2
            exit 1
          fi

          echo "out=$OUT" >> "$GITHUB_OUTPUT"

      - name: Ensure release exists (prompts-latest)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="prompts-latest"
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "Prompts Latest" --notes "Automated prompts release"
          fi

      - name: Upload asset (clobber)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="prompts-latest"
          FILE="${{ steps.prep.outputs.out }}"
          gh release upload "$TAG" "$FILE#prompts.yaml" --clobber

      - name: ✅ Verify asset exists (hard gate)
        id: verify
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="prompts-latest"
          SIZE=$(gh release view "$TAG" --json assets --jq '.assets[]? | select(.name=="prompts.yaml") | .size // 0')
          if [[ -z "$SIZE" || "$SIZE" -le 0 ]]; then
            echo "::error ::prompts.yaml not found or size=0 on release '$TAG'"
            exit 1
          fi
          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
          echo "## ✅ prompts.yaml uploaded (size=${SIZE} bytes) to release '$TAG'" >> "$GITHUB_STEP_SUMMARY"
# [01] END: .github/workflows/publish-prompts.yml — 입력/폴백→업로드→자산검증(전체 교체)
