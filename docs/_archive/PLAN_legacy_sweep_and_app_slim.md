
# MAIC 개선 로드맵 (v0.2) — **레거시 제거 → `app.py` 슬림화 → 그 외 순서**
Owner: @LEES1605  
Scope-of-Truth(SSOT): `docs/_gpt/`【13†Workspace Pointer】  
문서 위치 제안: `docs/PLAN_legacy_sweep_and_app_slim.md`

---

## 0) 목표와 원칙
- **우선순위:** ① 레거시 제거 스윕 → ② `app.py` 슬림화 → ③ 나머지(추천 순서 아래)  
- **협업 규약:** *한 번에 하나의 변경*, **숫자 구획 [NN] START/END 전체 교체**, PR 단위로 단계적 반영, **Actions-only(로컬 금지)**.  
- **보증:** 모든 변경은 PR에서 **ruff / mypy / pytest / CI 워크플로**를 통과해야 하며, 실패 시 즉시 롤백(토글/폴백).  
- **문서화:** 변경 시점마다 **SSOT( `docs/_gpt/` )** 문서를 동기화.【13†Workspace Pointer】

---

## 1) 전체 작업 스트림(Themes)
1. **Legacy Removal Sweep** — 사용되지 않는 파일/모듈/경로/참조의 안전한 일괄 제거.
2. **`app.py` Slim‑Down** — UI/서비스/관리자 패널/인덱싱 로직 분리(단일 책임 원칙).
3. **로깅·예외 표준화** — `logging` 일원화, 민감정보 마스킹, `raise ... from e` 준수.
4. **인덱싱 성능·안정성** — 스트리밍 JSONL 라이터, 대용량 가드, 증분 처리, 캐시.
5. **데이터 소스 인터페이스화** — `PreparedSource`(Protocol) 도입, GDrive/Local 등 다형성.
6. **비동기 인덱싱 오프로딩** — 백그라운드 작업자 + 상태 폴링 + 취소/재시도.
7. **CI 보안/품질 강화** — CodeQL/Bandit/gitleaks/pip‑audit, 커버리지 래칫.
8. **(마지막) 관리자 인증 하드닝** — 해시 검증, 권한 데코레이터, 시도 제한.

> 요청에 따라 **1→2**를 즉시 수행하고, 이후 **3→4→5→6→7→8** 순서로 진행합니다.

---

## 2) 단계별 PR 플랜 (한 PR = 한 변화)
각 PR은 **명확한 목표/AC(수용 기준)/롤백 전략**을 포함합니다.

### PR‑L1: 레거시 제거 스윕 — 1차(파일·폴더)
**목표:** 사용되지 않는 파일/폴더를 안전하게 제거(기능 영향 0).  
**절차:**  
- (a) 삭제 후보 리스트 작성: `docs/LEGACY_REMOVAL_TARGETS.md`(신규) — 경로/이유/참조 유무/대체 여부.  
- (b) 참조 여부 검증: 정적 검색(코드/문서/워크플로), import 그래프(예: pydeps 등) **→ Actions 상에서만 실행**.  
- (c) 제거: PR에서 파일/폴더 삭제.  
- (d) 회귀 확인: CI 통과, 앱 스모크 임포트 OK.  
**AC:** 앱 실행/테스트/CI 모두 그린, 사용자 기능 변화 없음.  
**롤백:** 동일 PR에서 파일 복구 가능(히스토리 유지).

### PR‑L2: 레거시 제거 스윕 — 2차(오브젝트·심볼)
**목표:** 살아있는 파일 내 **미사용 함수/클래스/상수/세션키** 제거.  
**절차:** 린터/커버리지·검색으로 미사용 식별 → 주석/호출망 확인 → 제거.  
**AC:** 타입체커/테스트 전부 Green, 공개 API(모듈 경계) 변화 시 CHANGELOG 명시.  
**롤백:** 심볼 단위 복원 가능.

### PR‑L3: 레거시 참조 방지 테스트(신규)
**목표:** 이후 PR에서 레거시가 재유입되지 않도록 **가드 테스트** 추가.  
**절차:** `tests/legacy/test_no_legacy_paths.py`(신규) — 금지 경로/모듈/심볼 문자열 스캔.  
**AC:** 금지 대상이 발견되면 테스트 실패.  
**롤백:** 테스트 리스트에서 항목 제외 가능(SSOT 문서 동시 수정).

---

### PR‑A1: `app.py` 슬림화 — 1차(관리자 패널 분리)
**목표:** `app.py`에서 **관리자 패널 UI/로직**을 별도 모듈로 이동.  
**결과 구조(예시):**
```
src/ui_admin/indexing_panel.py      # 인덱싱/복원/백업/상태 표시
src/services/index_state.py         # 인덱스 상태 조회/표준화
src/services/index_actions.py       # 스캔/빌드/백업/복원 단일 진입점
app.py                              # 라우팅·페이지 스켈레톤(슬림)
```
**AC:** 기능 동일, 공개 API 안정, CI Green.  
**롤백:** 모듈 revert로 즉시 복귀.

### PR‑A2: `app.py` 슬림화 — 2차(라우터·헤더/사이드바 정리)
**목표:** 페이지 라우팅·헤더·사이드바 보일러플레이트 최소화.  
**결과 구조(예시):**
```
src/ui/router.py                    # 라우팅·탭/모드 전환
src/ui/header.py                    # 헤더/상태 배지
src/ui/utils/sider.py               # 사이드바 유틸
app.py                              # 최소한의 연결 코드만 유지
```
**AC:** 동일 UX, 불필요한 상태키 제거/일원화.  
**롤백:** 라우팅만 되돌려도 앱 가동.

---

### 이후 권장 순서(간략)
- **PR‑L4:** SSOT 문서 싱크(삭제 사유/변경점 기록).  
- **PR‑R1:** 로깅·예외 표준화 프레임 도입.  
- **PR‑P1:** 스트리밍 JSONL 라이터 & 대용량 가드.  
- **PR‑I1:** PreparedSource(Protocol) + GDrive 구현/치환.  
- **PR‑X1:** 비동기 인덱싱(백그라운드 작업자 + 상태 파일 폴링).  
- **PR‑C1:** CI 보안/품질(코드QL/Bandit/gitleaks/pip‑audit/커버리지 래칫).  
- **PR‑S1:** (마지막) 관리자 인증 하드닝.

---

## 3) 체크리스트 (각 PR 공통)
- [ ] **한 번에 하나의 변경**만 포함(혼합 금지).  
- [ ] 변경 구역은 **숫자 구획 [NN] START/END 전체 교체** — 발췌/중략 금지.  
- [ ] ruff / mypy / pytest / Actions 워크플로 **Green**.  
- [ ] **SSOT 문서 동기화**(필요 시 `docs/_gpt/` 갱신).【13†Workspace Pointer】  
- [ ] CHANGELOG/릴리스 노트 갱신(가시적 변경 시).  
- [ ] 롤백 방법(PR 설명에 명시).

---

## 4) 리스크 & 완화
- **실수로 필요한 파일 삭제** → PR 리뷰 2인 승인 + 가드 테스트 + 빠른 revert.  
- **의존 꼬임/숨은 참조** → import 그래프 점검 + 스모크 임포트 테스트.  
- **`app.py` 분리 중 회귀** → 단계적 분리(A1 → A2), 공개 API 안정성 유지, 폴백 경로 확보.

---

## 5) 산출물
- `docs/LEGACY_REMOVAL_TARGETS.md` (삭제 후보 목록 & 근거)  
- `tests/legacy/test_no_legacy_paths.py` (가드 테스트)  
- `docs/_gpt/` 문서 갱신(SSOT)【13†Workspace Pointer】  
- PR별 체크리스트/검증 로그/CHANGELOG

---

## 6) 바로 다음 행동(Next 3)
1) **PR‑L1** 브랜치 생성 → 삭제 후보 수집용 문서 `docs/LEGACY_REMOVAL_TARGETS.md` 초안 작성.  
2) **PR‑L2** 대비해 미사용 심볼/세션키 후보를 린터/검색으로 사전 수집.  
3) **PR‑A1** 설계를 위해 `app.py`의 섹션([NN] 구획) 인벤토리 표를 만든 뒤, 이동 대상 정의.

> 이후, 내가 PR별 교체본을 작성할 때는 **파일명/구획 번호**를 먼저 물어보고, “원인 분석 → 수정 목표 → 구획 전체 코드 → 테스트 방법” 순으로 제시하겠습니다.
