# MASTERPLAN vNext — **Final Masterplan**  
(2025‑09‑29 · Grammar Double‑Agent + Summary, RAG‑Strict, SSOT Dedup, S1/H1 정합, Legal/E2E 확장)

**Scope**  
A1r(관리자 패널 분리) 이후의 합의안을 기반으로, **문법 모드 더블에이전트(PT=이유문법, MN=문법서적) + 요약/비교 단계**, **RAG 명시 주입/Strict 게이트**, **SSOT 중복 제거**, **S1/H1 UX 보완**, **개인정보 문서화/DSR/가명화**, **E2E 확장 원칙**까지 반영한 실행 가능한 청사진.

**SSOT (Single Source of Truth)**  
본 문서가 단일 진실 소스입니다. 모든 후속 PR/이슈/테스트는 **본 문서의 정의·AC**를 기준으로 작성/검증합니다.  
— 위치: `docs/_gpt/MASTERPLAN_vNext.md`  
— 스냅샷: `docs/_gpt/MASTERPLAN_vNext_YYYY-MM-DD.md`

**이 버전의 주요 변경점**  
- **A3‑DA**: 문법 모드에서 **PT(이유문법) → MN(문법서적)** 순차 스트림 **+ 요약/비교(3+1줄)** 단계(**A3‑DA‑SUM**) 추가  
- **RAG1**: 검색 Top‑K **프롬프트 명시 주입** + **Strict=ON**일 때 **무근거 답변 차단/가이드**  
- **QF4‑SSOT**: `persist` 경로 결정/`prepared` 로더/페이지 초기화 **중복 제거·단일화**  
- **S1**: 전송 즉시 **타이핑 버블**, 출처칩 **[검색중...] → 실제 출처** 지연 갱신(스트림 중단 없음)  
- **H1**: 헤더 **🟩/🟨/🟧** 3단계 판정 기준 **최신 릴리스 복원**으로 통일  
- **S2‑Legal**: `PRIVACY_POLICY.md` / `DATA_RETENTION.md` / **DSR(데이터 다운로드/삭제)** / **가명화 파이프라인**  
- **C3‑Plus**: **E2E 확장 원칙(Risk×Frequency×Impact)** 및 Top‑5 고위험 시나리오 묶음

---

## 0) 베이스라인(현행)
- 채팅 말풍선/좌우 정렬/내부 전송 버튼 CSS, 관리자 패널/오케스트레이터 헤더/자동 복원 훅 동작.
- 채팅 패널은 기존 **2단계 스트림(피티→미나)** 구현이 있으나, 최종 정책은 **문법 모드만 더블에이전트**, **문장/지문은 단일 에이전트**로 정합.
- 헤더 배지는 파일시스템 준비 외에 **최신 릴리스 복원 여부**를 반영하는 **3단계(🟩/🟨/🟧)** 표기.

> 용어  
> **피티(PT)** = 문법(이유문법 중심) · **미나(MN)** = 문장/지문(문법서적 중심)  
> **SC(요약/비교)** = 두 답변의 공통점/차이/결론 3+1줄로 응축하는 경량 단계

---

## 1) 결정 사항(최종 합의)

1) **프롬프트 자동변환(A2)**  
   _자연어 → 재작성 → 관용 파서/Auto‑Repair → (필요 시) Clarify ≤1회 → 실행_.  
   - Auto‑Repair 규칙 세트 유지(관용도=보통), 실패 시 단 1회 Clarify.

2) **에이전트 정책(A3)**  
   - **문법 모드 = 더블에이전트**: **PT(이유문법)** → **MN(문법서적)** 순차 스트림.  
   - **문장/지문 모드 = 단일 에이전트**: **MN**.  
   - 공통: **맥락 유지(최근 N턴 요약 주입)**, **모호 질문 Clarify** 후 답변.  
   - **A3‑DA‑SUM**: PT/MN 종료 후 **SC(요약/비교 3+1줄)** 자동 생성(기본 접힘).

3) **모델 라우팅(I3)**  
   - **기본 = GPT‑4o**, **폴백 = Gemini‑1.5**. 장애/쿼터 시 **무중단 전환**(내부 로그/배지).

4) **RAG(RAG1)**  
   - 검색 Top‑K를 **프롬프트에 명시 주입**.  
   - **Strict=ON**에서 근거 없으면 **답변 차단**·업로드/재질문 **가이드**.

5) **UI/UX (모바일 우선 + 미니멀리즘)**  
   - **M1**: **모바일 우선 설계**: 모든 UI 컴포넌트는 480px 이하 화면에서 최적화, 세로 스크롤 최소화.  
   - **M2**: **미니멀리즘 원칙**: 정보 밀도 최소화, 핵심 기능만 노출, 시각적 노이즈 제거.  
   - **S1**: 전송 직후 **타이핑 버블 즉시**, **0.2s 내 스트림 시작**. 출처칩은 **[검색중...] → 실제 출처**로 지연 갱신.  
   - **U1/U2**: 카카오 톤앤매너. 질문=노랑(#FFF8CC), 답변=하늘(#EAF6FF) 토큰 고정.  
   - **문법 모드**: PT/MN **각각 독립 버블·독립 출처칩**. **SC 버블은 회색(중립)**.

6) **보안/개인정보(S2 + S2‑Legal)**  
   - Supabase Auth(+RBAC), **관리자 승인형 가입**.  
   - 전화번호 **암호화/마스킹**, RLS, 세션 타임아웃.  
   - **PRIVACY_POLICY.md, DATA_RETENTION.md** 문서화, **동의 UI/로그**, **DSR(다운로드/삭제)**, **가명화 ETL**.

7) **E2E(C3 + C3‑Plus)**  
   - 스모크 2건으로 시작(채팅 1턴/헤더 칩 확인) → **Risk×Frequency×Impact** 기준으로 Top‑5 고위험 시나리오 추가.

---

## 1.5) 모바일 우선 설계 & 미니멀리즘 가이드라인

### **M1: 모바일 우선 설계 (Mobile-First Design)**
- **기본 원칙**: 모든 UI 컴포넌트는 **480px 이하 화면에서 최적화** 후 데스크톱 확장
- **레이아웃**: 세로 스크롤 최소화, 가로 공간 효율적 활용
- **터치 친화적**: 버튼 최소 44px, 충분한 터치 영역 확보
- **반응형 그리드**: 모바일 2x2, 태블릿 3x1, 데스크톱 4x1 레이아웃
- **성능 최적화**: 모바일에서 렌더링 지연 최소화, 메모리 사용량 제한

### **M2: 미니멀리즘 원칙 (Minimalism Principles)**
- **정보 밀도 최소화**: 한 화면에 표시되는 정보를 핵심만 제한
- **시각적 노이즈 제거**: 불필요한 장식, 과도한 색상, 복잡한 애니메이션 배제
- **기능 우선순위**: 가장 중요한 기능만 메인 화면에 노출
- **단계적 정보 공개**: 상세 정보는 접힘/확장 형태로 숨김
- **일관된 디자인 언어**: 색상, 폰트, 간격의 일관성 유지

### **M3: 관리자 모드 특화 가이드라인**
- **상태 표시**: 세로 나열 → 가로 그리드 카드 형태
- **로그 표시**: 최대 3개 항목, 80px 높이 제한 (모바일 60px)
- **버튼 레이아웃**: 모바일에서 2x2 그리드, 텍스트 간소화
- **중복 방지**: 동일 메시지 5초 내 중복 표시 방지
- **컴팩트 진행바**: 커스텀 HTML 진행바로 공간 효율성 극대화

---

## 2) PR 순서(최종)

1. **PR‑U3 (QF)** — ChatPane 클래스 분리·키 안정화(중복 렌더 0, 전송 버튼 위치 고정). **[완료]**  
2. **PR‑M1** — 모바일 우선 UI 최적화(관리자 모드 그리드, 로그 컴팩트, 반응형 CSS). **[완료]**  
3. **PR‑S1** — 타이핑 핸드셰이크 & 즉시 스트리밍(타이핑 ≤0.2s, 첫 토큰 ≤0.2s, 출처칩 지연 갱신).  
4. **PR‑H1** — 헤더 3단계 표기 & 최신 릴리스 인지(🟩=최신 복원).  
5. **PR‑RAG1** — Top‑K **프롬프트 명시 주입**, **Strict 게이트**.  
6. **PR‑A2** — Prompt Orchestrator(관용 파서·Auto‑Repair·Clarify≤1).  
7. **PR‑A3‑DA** — 문법 더블에이전트(PT→MN), 문장/지문=MN 단일, 맥락 유지·Clarify.  
8. **PR‑A3‑DA‑SUM** — **요약/비교(3+1줄)** 자동 생성, 상충 감지/권고문 포함.  
9. **PR‑QF4‑SSOT** — **중복 제거·정합**(persist/prepared/layout 단일화).  
10. **PR‑I3** — 모델 라우팅(기본/폴백, 폴백 로그/배지).  
11. **PR‑C3** — Playwright E2E 스모크(2건).  
12. **PR‑C3‑Plus** — **E2E 확장 원칙** + Top‑5 고위험 시나리오.  
13. **PR‑S2** — Supabase Auth(+RBAC), 관리자 승인 가입.  
14. **PR‑S2‑Legal** — Privacy/Retention 문서, 동의 UI/로그, DSR, 가명화 ETL.  
15. **PR‑U1/U2** — 디자인 토큰/컴포넌트화.  
16. **PR‑I4‑Image** — 이미지 업로드→세션 한정 OCR/비전(영어 지문/문제), PDF 제외.

---

## 3) 각 PR의 목표/AC(수용기준)

### PR‑U3 (QF)
- **목표**: `.chatpane-messages` / `.chatpane-input` 분리 + 키 안정화.  
- **AC**: 전송 후 **중복 렌더 0**, 전송 버튼(➤) **입력 필드 내부 우측 고정**(모바일 포함).

### PR‑M1 (Mobile-First UI Optimization)
- **목표**: 모바일 우선 설계 적용, 관리자 모드 UI 미니멀화, 반응형 CSS 구현.  
- **AC**:  
  1) 관리자 모드 상태 표시가 **가로 그리드 카드** 형태로 변경.  
  2) 로그 표시 **최대 3개 항목**, 컨테이너 높이 **80px 제한** (모바일 60px).  
  3) 버튼 레이아웃 **모바일 2x2 그리드**, 데스크톱 4x1.  
  4) **480px 이하** 화면에서 모든 요소 정상 표시.  
  5) 중복 로그 메시지 **5초 내 방지**.  
- **테스트**: 320px~1920px 뷰포트에서 레이아웃 깨짐 없음.

### PR‑S1 (Typing & Streaming)
- **목표**: **전송 즉시 타이핑 버블**, **0.2s 내 스트림 시작**. 출처칩 **[검색중...]** → 실제 출처 **지연 갱신**.  
- **AC**:  
  1) 타이핑 버블 **≤0.2s**(PT/MN 라벨 반영).  
  2) 첫 토큰 **≤0.2s** 누적 스트림.  
  3) 출처칩 초기 **[검색중...]** → 실제 출처로 교체(스트림 **중단 없음**).  
- **테스트(수동)**: 빈 회색 구간 없이 타이핑 선표시.

### PR‑H1 (Header Tri‑state)
- **목표**: **🟩/🟨/🟧** 3단계 표기, **최신 릴리스 복원** 시에만 **🟩 READY**.  
- **AC**: 메타 불일치/부재 시 **🟨/🟧만** 노출, 복원 성공 시 **🟩** 전환(설명/세션 상태 동기).

### PR‑RAG1 (Context Injection + Strict)
- **목표**: 검색 Top‑K를 프롬프트에 **명시 주입**. **Strict=ON**에서 근거 0건이면 **답변 차단/가이드**.  
- **AC**:  
  - RAG 모드 답변 **최소 1개 이상 출처칩**.  
  - Strict에서 Top‑K=0 → 답변 차단 메시지(업로드/재질문 안내).

### PR‑A2 (Prompt Orchestrator)
- **목표**: 재작성 → 관용 파서 → Auto‑Repair → 실패 시 Clarify ≤1.  
- **AC**: 자유자연어 50샘플 **자동 보정 ≥95%**, 실패분 **Clarify 회수**.

### PR‑A3‑DA (Grammar Double‑Agent)
- **목표**: 문법 모드에서 **PT(이유문법) → MN(문법서적)** **순차 스트리밍**. 문장/지문=MN 단일.  
- **AC**:  
  - 문법 모드에서 **버블 2개**(PT/MN) 각각 **타이핑→스트림** OK.  
  - 각 버블 **독립 출처칩**(예: PT=[Reasoning], MN=[서명/쪽]). **본문 인라인 인용 ≥1회**/답변의 80%에서 충족.  
  - **연속 3턴 이상 맥락 유지**(이전 대화 요약 주입).  
  - **Clarify ≤2회** 경로에서도 렌더/버블 깨짐 없음.

### PR‑A3‑DA‑SUM (Summary & Compare 3+1)
- **목표**: PT/MN 종료 후 **요약 3줄 + 결론 1줄** 생성(기본 접힘). 상충 시 공통/차이/추천 기준 포함.  
- **성능 가드**: **토큰 ≤300**, **지연 ≤1.2s**(두 답변 완료 후 호출).  
- **AC**:  
  - 요약 버블(회색, ‘요약’ 칩) **깨짐 없음**.  
  - 상충 케이스에서 **차이·추천 문장** 노출.  
  - 요약 본문에도 최소 1회 **[이유문법]/[문법서적] 인라인 인용**.

### PR‑QF4‑SSOT (Dedup & Consistency)
- **목표**: **SSOT 단일화·중복 제거**.  
- **스코프**:  
  1) **persist 경로 결정**: 진입점 헬퍼 제거 → `src.core.persist.effective_persist_dir()` 단일 호출.  
  2) **prepared 로더**: app/services 중복 제거 → `src/integrations/gdrive_prepared.py` 또는 `src/services/prepared_loader.py` **단일화**.  
  3) **페이지 초기화**: `layout.init_page(title, sidebar=False)` 1줄 호출로 통일(`st.set_page_config`/CSS 반복 제거).  
- **AC**: 호출부 **전량 치환**, 공통 모듈 **핵심 함수 단위테스트 100%**.

### PR‑I3 (Model Routing & Fallback)
- **목표**: 기본 **GPT‑4o**, 장애/쿼터 시 **Gemini‑1.5**로 **무중단 전환**.  
- **AC**: 폴백 시 사용자 오류 노출 없음, 내부 **로그·배지 지표**로 인지 가능.

### PR‑C3 (E2E Smoke)
- **목표**: GH Actions 헤드리스 E2E. **trace/video/screenshot** 아티팩트.  
- **시나리오**: (1) 홈→질문→버블 1쌍(중복 0) (2) 관리자 토글→헤더 칩 확인.  
- **AC**: 2건 Green, 실패 시 trace.zip 자동 첨부.

### PR‑C3‑Plus (E2E Expansion Principles)
- **목표**: `TESTING_GUIDE.md`에 **Risk×Frequency×Impact** 기준 명시, **Top‑5 고위험** 시나리오 추가.  
- **AC**: 신규 5건 중 **≥4건 Green**, 실패 시 trace.zip 첨부.

### PR‑S2 (Auth + RBAC, Admin Approval)
- **목표**: 아이디/비번/이름/학교/전화번호 → **관리자 승인형** 가입.  
- **AC**: 가입→승인→로그인→역할별 UI 제약, 비승인 상태에서 주요 API 접근 불가.

### PR‑S2‑Legal (Privacy/Retention/DSR/Pseudonymization)
- **목표**:  
  - `docs/legal/PRIVACY_POLICY.md`: 수집항목/이용목적/보관기간/파기/3자 제공/국외 이전/권리.  
  - `docs/legal/DATA_RETENTION.md`: 항목별 보관주기, 백업/스냅샷 파기.  
  - **동의 UI/로그**, **DSR(다운로드/삭제) 티켓**, **가명화 ETL**(분석용).  
- **AC**: 문서 2종 리포 포함, 동의 이력 저장, PII **필드 암호화**(전화번호 등), DSR 처리 SLA(≤14일).

### PR‑U1/U2 (Design Tokens & Components)
- **목표**: 카카오 톤앤매너 컴포넌트화.  
- **AC**: 모든 뷰포트에서 색/꼬리/여백 일관, 회귀 0.

### PR‑I4‑Image (Image Q&A)
- **목표**: 스마트폰 촬영/업로드 → **세션 한정** OCR/비전 추출 → 금번 질문 프롬프트 주입. **PDF 제외**.  
- **AC**: 대표 샘플셋 성공률 기준 통과, 실패 시 재촬영/영역선택 가이드.

---

## 4) 테스트/품질

**CI 기본**: `pytest`, `ruff`, `mypy`, `bandit`, `pip‑audit`  
**E2E**: `npx playwright install --with-deps` → 헤드리스 실행, 실패 시 **trace/video/screenshot** 업로드  
**플레이키 방지**: 시간/랜덤성 **시드 주입**, 네트워크 호출 **목킹/레이트제어**  
**커버리지**: 공통 모듈(QF4‑SSOT) **핵심 함수 100%** / 에이전트 경로 최소 **70%** 목표  
**메트릭(SLO)**  
- **S1**: 타이핑 TTV ≤ **0.2s**, 첫 토큰 ≤ **0.2s**  
- **A3‑DA‑SUM**: 요약 지연 ≤ **1.2s**, 토큰 ≤ **300**  
- **RAG1**: Strict 차단 오탐률 ≤ **5%**, 무근거 답변률 ≤ **1%**  
- **I3**: 폴백 전환 성공률 ≥ **99.5%**, 사용자 오류 노출 0건

---

## 5) 보안/개인정보

- **접근제어**: Supabase **RLS** 최소권한, 역할별 UI 제한  
- **암호화**: 전화번호 등 PII **필드 레벨 암호화**(KMS/Secrets 관리), 로그 마스킹  
- **세션/비밀**: 세션 타임아웃, 비밀값은 **환경변수/Secrets**만  
- **법적 체계**: `PRIVACY_POLICY.md` / `DATA_RETENTION.md`, **동의 UI**/이력, **DSR(다운로드/삭제)** 절차  
- **가명화**: 분석용 데이터셋 **가명/익명 처리** ETL 파이프라인  
- **침해 대응**: 사고대응 핸드북(탐지→차단→통지→재발방지)

---

## 6) 리스크와 완화

- **프롬프트 실패/모호성** → A2 **Auto‑Repair + Clarify(≤1)**  
- **모델 한계/쿼터/지연** → I3 **무중단 폴백**, 이벤트 **로그/배지**  
- **UI 중복/깨짐** → U3 안정화, A3‑DA/E2E 커버로 회귀 방지  
- **근거 부족/환각** → RAG1 **Strict 게이트** + 업로드/재질문 가이드  
- **요약 비용·지연** → A3‑DA‑SUM **토큰/지연 상한**, **후행 호출**  
- **개인정보 법적 리스크** → S2‑Legal **문서/동의/DSR/암호화** 동시 구축

---

## 7) 운영 가이드/리포 구조

- **SSOT 문서**: `docs/_gpt/MASTERPLAN_vNext.md` (본 문서)  
  - 스냅샷: `docs/_gpt/MASTERPLAN_vNext_YYYY-MM-DD.md`  
- **PR 문서**: `docs/pr/PR-*.md` (이유/스코프/AC/테스트/롤백 포함)  
- **테스트 가이드**: `docs/TESTING_GUIDE.md` (C3‑Plus 원칙/케이스/리스크 링크)  
- **권장 워크플로**  
  1) SSOT 문서를 `main`에 커밋(고정)  
  2) 각 PR은 **본 문서 참조**를 PR 설명에 명시  
  3) CI Green & 리뷰 승인 → 머지(릴리스 노트/스냅샷 갱신)

---

## 8) 실행 체크리스트

- [x] **M1**: 모바일 우선 UI 최적화(관리자 모드 그리드, 로그 컴팩트, 반응형 CSS) **[완료]**  
- [ ] **S1**: 타이핑/첫 토큰 **≤0.2s**, 출처칩 **지연 갱신**  
- [ ] **H1**: 헤더 **🟩/🟨/🟧** 정확 동작(최신 복원=🟩)  
- [ ] **RAG1**: Top‑K **프롬프트 주입**, **Strict 차단/가이드**  
- [ ] **A2**: Auto‑Repair 규칙/Clarify ≤1 **튜닝 지표** 확정  
- [ ] **A3‑DA**: 문법=PT→MN 더블, 문장/지문=MN 단일, **인라인 인용 ≥1회**  
- [ ] **A3‑DA‑SUM**: **3+1줄** 요약, 상충 감지/권고, **≤300t/≤1.2s**  
- [ ] **QF4‑SSOT**: persist/prepared/layout **중복 제거 커밋**  
- [ ] **I3**: 폴백 UX 정상(오류 노출 없음), **로그/배지** 지표  
- [ ] **C3**: 스모크 2건 Green, trace.zip 첨부  
- [ ] **C3‑Plus**: Top‑5 고위험 케이스 문서화/자동화  
- [ ] **S2**: 가입→승인→역할 제약 **E2E 통과**  
- [ ] **S2‑Legal**: Privacy/Retention 문서, **동의 UI/로그**, **DSR**, **가명화 ETL**

---

## 부록 A) 프롬프트 구조(요지)

- **PT(이유문법)**: 원리/형성 이유 → 예문/반례(1) → 개념 경계 → 오개념 방지  
- **MN(문법서적)**: 규정/용례 → 문헌 인용(책/판/쪽/절) → 예외/주의 → 학년별 설명  
- **SC(요약/비교)**: 공통(1줄)·차이(1줄)·핵심(1줄) + **결론(1줄)** → 상충 시 추천 기준/학습 단계별 권고

---

## 부록 B) E2E Top‑5 예시(C3‑Plus)

1) **골든패스**: 가입→승인→로그인→첫 질문(문법/문장)  
2) **RAG‑Strict**: Top‑K=0 → 차단 & 가이드 문구  
3) **A3‑DA‑SUM**: PT→MN→요약(상충/비상충 각 1)  
4) **I3 폴백**: OpenAI 실패→Gemini 전환, 버블/칩 유지  
5) **I4 이미지**: 업로드/OCR 실패→재시도 가이드, 성공→컨텍스트 주입

