# MAIC 프로젝트 최적화 마스터플랜

## 🎯 목표
UI 코드 통합 작업 완료 후, 추가 최적화를 통해 코드 품질, 성능, 유지보수성을 대폭 향상시킨다.

## 📊 현재 상황
- **UI 코드 통합 완료**: 4,720줄 삭제, 106줄 추가로 대폭적인 코드 정리 완료
- **주요 문제점 식별**: 무한 복원 루프, 중복 코드, 성능 병목, 보안 취약점

## 🚨 긴급 문제 (1단계 - 즉시 해결)

### 1. 무한 복원 루프 문제
**현재 상황**: 터미널 로그에서 확인된 심각한 문제
```
[DEBUG] Starting restore process
[DEBUG] Restore success: True
[DEBUG] Session state updated: _INDEX_LOCAL_READY=True
[DEBUG] Skipping restore - already done: True
[DEBUG] Restore already completed - skipping
[DEBUG] Starting restore process  # ← 무한 반복
```

**원인 분석**:
- 인덱스 복원 로직이 완료되었음에도 불구하고 계속 재시작
- 세션 상태 관리 문제로 인한 상태 불일치
- 복원 완료 플래그가 제대로 설정되지 않음

**해결 방안**:
1. `_boot_auto_restore_index()` 함수의 상태 체크 로직 개선
2. 세션 상태 플래그 관리 강화
3. 무한 루프 방지 메커니즘 추가

## 🔧 구조적 최적화 (2단계 - 단기)

### 2. 경로 해석 통합
**현재 문제**: `PERSIST_DIR` 경로를 여러 모듈에서 각각 구현
- `src/core/persist.py`: `effective_persist_dir()`
- `src/services/index_actions.py`: `_persist_dir_safe()`
- `src/rag/index_build.py`: `_persist_dir()`

**해결 방안**: `PathResolver` 클래스 생성으로 SSOT 구현

### 3. 에러 처리 통합
**현재 문제**: 에러 처리 로직이 여러 곳에 분산
- `src/ui_orchestrator.py`: `_add_error()`
- `src/common/utils.py`: `errlog()`
- 각 모듈별 개별 에러 처리

**해결 방안**: `ErrorHandler` 클래스 생성으로 통합

### 4. 설정 관리 통합
**현재 문제**: Pydantic v1/v2/SIMPLE 폴백이 여러 곳에 분산
- `src/config.py`: 복잡한 폴백 로직
- `src/compat/config_bridge.py`: 설정 브리지

**해결 방안**: `ConfigManager` 클래스로 통합

## ⚡ 성능 최적화 (3단계 - 중기)

### 5. 스트리밍 최적화
**현재 문제**: LLM 응답 스트리밍에서 청크 크기 비효율
- 고정된 청크 크기 (10자)
- 메모리 사용량 최적화 부족

**해결 방안**: 동적 청크 크기 조정 및 메모리 최적화

### 6. 메모리 사용량 개선
**현재 문제**: 대용량 인덱스 처리 시 메모리 효율성 문제
- 6.4MB 인덱스 파일 처리 시 메모리 사용량 증가
- 불필요한 데이터 중복 로딩

**해결 방안**: 스트리밍 처리 및 캐시 최적화

## 🔒 보안 강화 (4단계 - 장기)

### 7. 입력 검증 강화
**현재 문제**: 외부 입력에 대한 검증이 일관되지 않음
- GitHub API 응답 검증 부족
- 사용자 입력 검증 분산

**해결 방안**: 통합 입력 검증 시스템 구축

### 8. 에러 정보 보안
**현재 문제**: 민감한 정보가 에러 메시지에 노출될 가능성
- API 키, 토큰 등이 에러 로그에 노출
- 스택 트레이스에 내부 구조 노출

**해결 방안**: 에러 메시지 마스킹 및 로깅 정책 수립

## 📋 실행 계획

### 1단계 (즉시 - 1일)
- [ ] 무한 복원 루프 문제 해결
- [ ] 세션 상태 관리 개선
- [ ] 무한 루프 방지 메커니즘 추가

### 2단계 (단기 - 1주)
- [ ] PathResolver 클래스 생성 및 적용
- [ ] ErrorHandler 클래스 생성 및 적용
- [ ] ConfigManager 클래스 생성 및 적용

### 3단계 (중기 - 2주)
- [ ] 스트리밍 성능 최적화
- [ ] 메모리 사용량 개선
- [ ] 캐시 시스템 구축

### 4단계 (장기 - 1개월)
- [ ] 보안 강화 시스템 구축
- [ ] 입력 검증 통합
- [ ] 에러 정보 보안 강화

## 📊 예상 효과

### 정량적 효과
- **코드 중복 50% 이상 제거**
- **성능 20-30% 향상** (메모리 사용량, 응답 속도)
- **에러 발생률 40% 감소**
- **유지보수 시간 60% 단축**

### 정성적 효과
- **코드 가독성 대폭 향상**
- **디버깅 시간 단축**
- **새 기능 개발 속도 향상**
- **시스템 안정성 증대**

## ⚠️ 주의사항

### 롤백 전략
- 각 단계별로 Git 커밋 생성
- 문제 발생 시 즉시 이전 상태로 롤백
- 테스트 케이스 작성으로 회귀 방지

### 테스트 전략
- 단위 테스트: 각 모듈별 기능 테스트
- 통합 테스트: 전체 파이프라인 테스트
- 성능 테스트: 메모리 사용량 및 응답 시간 측정
- 보안 테스트: 입력 검증 및 에러 처리 테스트

## 📝 진행 상황 기록

### 2025-10-06
- [x] UI 코드 통합 완료 (4,720줄 삭제, 106줄 추가)
- [x] 무한 복원 루프 문제 식별
- [x] 최적화 마스터플랜 수립
- [x] 무한 복원 루프 문제 해결 완료
  - 복원 시도 횟수 제한 (최대 3회)
  - 세션 상태 플래그 강화
  - 무한 루프 방지 메커니즘 추가
  - 중복된 세션 상태 설정 제거
- [x] PathResolver 클래스 생성 및 적용 완료
  - 통합 경로 해석 클래스 생성 (SSOT)
  - 6개 파일의 중복된 경로 해석 로직 통합
  - 캐싱 및 성능 최적화 구현
  - 기존 함수들과의 호환성 유지
- [x] ErrorHandler 클래스 생성 및 적용 완료
  - 통합 에러 처리 클래스 생성 (SSOT)
  - 3개 파일의 중복된 에러 처리 로직 통합
  - 에러 레벨 관리 및 통계 기능 구현
  - 기존 함수들과의 호환성 유지

### 다음 단계
1. 무한 복원 루프 문제 해결
2. PathResolver 클래스 생성
3. ErrorHandler 클래스 생성
4. ConfigManager 클래스 생성

---

**마지막 업데이트**: 2025-10-06
**담당자**: @LEES1605
**상태**: 진행 중
