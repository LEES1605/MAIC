
# MASTERPLAN vNext — **Consensus Draft** (2025‑09‑21)
**Scope:** A1r(관리자 패널 분리) 이후의 최종 합의안을 반영한 로드맵/AC(수용기준).  
**SSOT:** 이 문서가 단일 진실 소스입니다. 모든 후속 PR은 본 문서를 기준으로 작성/검증합니다.

---

## 0) 베이스라인(현행)
- 채팅 말풍선/좌우 정렬/내부 전송 버튼 CSS가 이미 포함되어 있으며, 관리자 패널/오케스트레이터 헤더/자동 복원 훅이 동작 중입니다. fileciteturn2file0 fileciteturn2file1
- 현재 채팅 패널은 “피티쌤 → 미나쌤” 2단계 스트림이 구현되어 있으나(답변→평가), 본 합의안에서는 **단일 에이전트 선택형**으로 전환합니다. fileciteturn2file1

> 용어: **피티(PT)**=문법에 강한 선생님, **미나(MN)**=문장/지문 지도에 강한 선생님.

---

## 1) 이번 합의(결정 사항)
1) **프롬프트 자동변환**은 실패 없이 고쳐 쓰는 **관용 파이프라인**으로: _자연어 → 재작성 → 관용 파서/Auto‑Repair → (필요 시) Clarify 1회 → 실행_  
2) **에이전트 정책**: 학생이 **한 명**(피티/미나)을 선택해 답변을 받음. **맥락 유지**, **모호 질문 시 Clarify** 후 답변.  
   - 기본 매핑: **문법=피티**, **문장=미나**, **지문=미나**  
3) **모델 기본/폴백**: **GPT‑4o → Gemini‑1.5**  
4) **가입/로그인(학생)**: **Supabase**, “아이디/비번·이름·학교·전화번호”로 가입 → **관리자 승인형**. 부모 인증 없음.  
   - 내부적으로 **가상 이메일(`아이디@noemail.local`)**을 생성해 Supabase 요구사항을 만족(권장안).  
5) **UI 톤앤매너**: 카카오 스타일. **질문 버블=파스텔 노란색**, **답변 버블=파스텔 하늘색**(현 CSS 값 표준화: `#FFF8CC`/`#EAF6FF`) fileciteturn2file0  
6) **멀티모달**: **이미지(촬영/업로드)만** 지원(영어 지문/문제 중심). **PDF는 제외**.  
7) **E2E(Playwright)**: **도입**. GitHub Actions에서 **스모크 2개**로 시작(채팅 1턴, 관리자 진입/헤더 칩 확인).

---

## 2) PR 순서(최종)
1. **PR‑U3 (QF)** — ChatPane 클래스 분리·키 안정화(중복 화면/버튼 위치 즉시 해결). fileciteturn2file0  
2. **PR‑RAG1** — 답변기에 **자료 문맥 주입**(출처칩·무근거 차단). fileciteturn2file1  
3. **PR‑A2** — Prompt Orchestrator(관용 파서·Auto‑Repair·Clarify 1회).  
4. **PR‑A3** — **Single‑Agent**(피티/미나 중 택1) + 맥락 유지 + 모호질문 Clarify.  
5. **PR‑I3** — 모델 라우팅(기본 GPT‑4o, 폴백 Gemini‑1.5).  
6. **PR‑C3** — **Playwright E2E 스모크**(GH Actions).  
7. **PR‑S2** — Supabase Auth(+RBAC), **관리자 승인형 가입**.  
8. **PR‑U1/U2** — 카카오 톤앤매너 디자인 토큰/컴포넌트화.  
9. **PR‑I4‑Image** — 이미지 업로드→세션 한정 컨텍스트(영어 지문/문제), **PDF 제외**.

---

## 3) 각 PR의 목표/AC(요약)

### PR‑U3 (QF)
- **목표**: 메시지/입력 컨테이너 **클래스 분리**(`.chatpane-messages`/`.chatpane-input`) + placeholder 키 안정화.  
- **AC**: 전송 후 **중복 렌더 0** / **버튼(➤)이 입력 필드 내부 우측에 고정**(모바일 포함). fileciteturn2file0

### PR‑RAG1
- **목표**: Retrieval Top‑K를 `answer_stream()`에 **명시 주입**. **Strict 모드**에서 근거 없으면 답변 차단·업로드 권고.  
- **AC**: RAG 모드에서 **최소 1개 이상 출처칩** 표기, Strict에서 무근거 답변 차단. fileciteturn2file1

### PR‑A2 (Prompt Orchestrator)
- **목표**: 자연어 → 템플릿 재작성 → **관용 파서 검증** → **Auto‑Repair** → 실패 시 **Clarify 1회**.  
- **AC**: 자유자연어 50샘플 기준 **자동 보정 ≥95%**. 실패 케이스는 **Clarify 1회**로 회수.

### PR‑A3 (Single‑Agent)
- **목표**: 학생이 피티/미나 중 1명 선택. **모드별 기본 매핑(문법=PT, 문장/지문=MN)**. **맥락 유지** + **Clarify≤2회**.  
- **AC**: 연속 3턴 이상 맥락 유지, Clarify 경로에서도 렌더·버블 깨짐 없음.

### PR‑I3 (Model Routing)
- **목표**: 프롬프트/모드 기준 Provider/Model/온도/토큰상한 설정. **기본=GPT‑4o, 폴백=Gemini‑1.5**.  
- **AC**: 기본/폴백 모두 정상 동작, 할당량/오류 시 즉시 폴백(로그·배지).

### PR‑C3 (Playwright E2E)
- **목표**: GH Actions 헤드리스 E2E. **trace/video/screenshot**를 PR 아티팩트로 첨부.  
- **1차 시나리오**: (1) 홈→질문→내부 전송 버튼→버블 1쌍(중복 0) (2) 관리자 토글→오케스트레이터 헤더 칩 확인.  
- **AC**: 스모크 2건 Green, 실패 시 trace.zip 자동 첨부.

### PR‑S2 (Supabase Auth + RBAC, 관리자 승인)
- **입력**: **아이디, 비번, 이름, 학교, 전화번호**. 가입 후 **관리자 승인**되면 사용 가능.  
- **권장 구현**: 아이디로 **가상 이메일**(`아이디@noemail.local`)을 내부 생성하여 Supabase Auth와 정합.  
- **보안**: 전화번호 컬럼 **암호화/마스킹**, RLS 정책, 세션 타임아웃.  
- **AC**: 가입→승인→로그인→역할별 UI 제약, 비승인 상태에서 주요 API 접근 불가.

### PR‑U1/U2 (디자인 시스템/컴포넌트화)
- **목표**: **카카오 톤앤매너** 고정. 버블 색상 토큰 `--bubble-user:#FFF8CC`, `--bubble-ai:#EAF6FF`.  
- **AC**: 모든 뷰포트에서 색/꼬리/여백 일관, 회귀 0. fileciteturn2file0

### PR‑I4‑Image (이미지 업로드 질문)
- **목표**: 스마트폰 촬영/이미지 업로드 → **세션 한정** OCR/비전 추출 → 이번 질문에만 주입. **PDF 제외**.  
- **AC**: 대표 샘플셋에서 추출 성공률 확보, 실패 시 명확 가이드(재촬영·영역선택 등).

---

## 4) 테스트/품질
- **CI 기본**: pytest, ruff, mypy, bandit, pip‑audit. (C‑라인은 기존 계획 유지)  
- **E2E**: `npx playwright install --with-deps` → 헤드리스 실행, 실패 시 trace/video/screenshot 업로드.  
- **플레이키 방지**: 시간/랜덤성 주입, 네트워크 호출 목킹/레이트제어.

---

## 5) 보안/개인정보
- Supabase RLS로 역할별 최소권한, 전화번호는 **암호화/마스킹** 저장.  
- 관리자 승인 전까지는 기능 제한(대기 상태 UI).  
- 로그에 개인정보/토큰 출력 금지, 비밀값은 환경변수/Secrets만.

---

## 6) 리스크와 완화
- **프롬프트 실패**: A2의 Auto‑Repair와 Clarify로 회수.  
- **모델 한계/할당량**: I3 폴백(GPT‑4o↔Gemini‑1.5) 즉시 전환.  
- **UI 중복/깨짐**: U3 키 안정화·클래스 분리(QF)로 선해결. fileciteturn2file0

---

## 7) 리포 배치/운영 가이드
- **문서 위치(SSOT)**: `docs/_gpt/MASTERPLAN_vNext.md`  
  - 날짜 스냅샷을 남기려면 `docs/_gpt/MASTERPLAN_vNext_2025-09-21.md` 같이 보관.  
- **PR 문서**: 각 작업별 `docs/pr/PR-*.md` (이유/스코프/AC/테스트/롤백 포함).  
- **권장 워크플로**:  
  1) 이 문서를 `main`에 커밋(SSOT 고정)  
  2) 각 PR은 **이 문서 참조**를 반드시 포함  
  3) CI Green & 리뷰 후 머지

---

## 8) 다음 단계(실행 전 체크리스트)
- [ ] U3 범위 확정(클래스 네이밍/키 정책)  
- [ ] RAG1 주입 포맷(Top‑K/메타/문장단 인용) 합의  
- [ ] A2 관용도=**보통**, Clarify=**1회**로 시작 (필요시 튜닝)  
- [ ] A3 기본 선생님: **문법=PT, 문장/지문=MN**, 전환 UI 확정  
- [ ] I3 기본/폴백 순서: **GPT‑4o → Gemini‑1.5**  
- [ ] C3 E2E 스모크 2건 대상 화면의 **data-testid**/텍스트 고정  
- [ ] S2 가입 폼 항목/승인 흐름(UI) 와이어프레임 점검

> 본 문서가 승인되면 `docs/_gpt/`에 업로드하고, 이후 각 PR을 순서대로 제안합니다.
