# ==== [01] future import =====================================================
from __future__ import annotations

# ==== [02] bootstrap & imports ==============================================
import os, io, json, time, traceback, importlib
from pathlib import Path
from typing import Any, Dict, List, Optional

try:
    import streamlit as st
except Exception:
    st = None  # Î°úÏª¨/ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω Î∞©Ïñ¥

# ==== [03] secrets ‚Üí env ÏäπÍ≤© & ÏÑúÎ≤Ñ ÏïàÏ†ï ÏòµÏÖò ===============================
def _from_secrets(name: str, default: Optional[str] = None) -> Optional[str]:
    try:
        if st is None or not hasattr(st, "secrets"):
            return os.getenv(name, default)
        val = st.secrets.get(name, None)  # type: ignore[attr-defined]
        if val is None:
            return os.getenv(name, default)
        if isinstance(val, str):
            return val
        return json.dumps(val, ensure_ascii=False)
    except Exception:
        return os.getenv(name, default)

def _bootstrap_env() -> None:
    keys = [
        "OPENAI_API_KEY","OPENAI_MODEL","GEMINI_API_KEY","GEMINI_MODEL",
        "GITHUB_TOKEN","GITHUB_REPO",
        "GDRIVE_PREPARED_FOLDER_ID","GDRIVE_BACKUP_FOLDER_ID",
        "APP_MODE", "AUTO_START_MODE", "LOCK_MODE_FOR_STUDENTS", "APP_ADMIN_PASSWORD",
    ]
    for k in keys:
        v = _from_secrets(k)
        if v and not os.getenv(k):
            os.environ[k] = str(v)
    os.environ.setdefault("STREAMLIT_SERVER_FILE_WATCHER_TYPE", "none")
    os.environ.setdefault("STREAMLIT_RUN_ON_SAVE", "false")
    os.environ.setdefault("TOKENIZERS_PARALLELISM", "false")
    os.environ.setdefault("STREAMLIT_SERVER_ENABLE_WEBSOCKET_COMPRESSION", "false")

_bootstrap_env()

# ==== [04] Í≤ΩÎ°ú/ÏÉÅÌÉú & ÏóêÎü¨Î°úÍ∑∏ ==============================================
def _persist_dir() -> Path:
    try:
        from src.config import PERSIST_DIR as CFG
        return Path(CFG).expanduser()
    except Exception:
        return Path.home() / ".maic" / "persist"

PERSIST_DIR = _persist_dir()
PERSIST_DIR.mkdir(parents=True, exist_ok=True)

def _is_brain_ready() -> bool:
    p = PERSIST_DIR
    if not p.exists(): return False
    signals = ["chunks.jsonl","manifest.json",".ready","faiss.index","index.faiss","chroma.sqlite","docstore.json"]
    for s in signals:
        fp = p / s
        try:
            if fp.exists() and fp.stat().st_size > 0:
                return True
        except Exception:
            pass
    return False

def _mark_ready() -> None:
    try: (PERSIST_DIR / ".ready").write_text("ok", encoding="utf-8")
    except Exception: pass

def _errlog(msg: str, *, where: str = "", exc: BaseException | None = None) -> None:
    if st is None: return
    ss = st.session_state
    ss.setdefault("_error_log", [])
    ss["_error_log"].append({
        "ts": time.strftime("%Y-%m-%d %H:%M:%S"),
        "where": where, "msg": str(msg),
        "trace": traceback.format_exc() if exc else "",
    })

def _errlog_text() -> str:
    if st is None: return ""
    out = io.StringIO()
    for i, r in enumerate(st.session_state.get("_error_log", []), 1):
        out.write(f"[{i}] {r['ts']} {r.get('where','')}\n{r['msg']}\n")
        if r.get("trace"): out.write(r["trace"] + "\n")
        out.write("-"*60 + "\n")
    return out.getvalue()

# ==== [05] ÎèôÏ†Å ÏûÑÌè¨Ìä∏ Î∞îÏù∏Îî© ===============================================
_import_warns: List[str] = []

def _try_import(mod: str, attrs: List[str]) -> Dict[str, Any]:
    out: Dict[str, Any] = {}
    try:
        m = importlib.import_module(mod)
    except Exception as e:
        _import_warns.append(f"{mod}: {type(e).__name__}: {e}")
        return out
    for a in attrs:
        try:
            out[a] = getattr(m, a)
        except Exception:
            pass
    return out

_ui_admin = _try_import("src.ui_admin", [
    "ensure_admin_session_keys", "render_admin_controls", "render_role_caption", "render_mode_radio_admin"
])
_ui_orch  = _try_import("src.ui_orchestrator", ["render_index_orchestrator_panel"])
_gh       = _try_import("src.backup.github_release", ["restore_latest"])
_rag      = _try_import("src.rag.index_build", ["build_index_with_checkpoint"])
_llm      = _try_import("src.llm.providers", ["call_with_fallback"])

# ==== [06] ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï & Ìó§Îçî + Î°úÍ∑∏Ïù∏ ÌÜ†Í∏Ä =================================
if st:
    st.set_page_config(page_title="AI Teacher", layout="wide")

def _is_admin_view() -> bool:
    env = (os.getenv("APP_MODE") or _from_secrets("APP_MODE","student") or "student").lower()
    return bool(env == "admin" or (st and (st.session_state.get("is_admin") or st.session_state.get("admin_mode"))))

def _toggle_login_flag():
    st.session_state["_show_admin_login"] = not st.session_state.get("_show_admin_login", False)

def _header():
    if st is None: return
    left, right = st.columns([0.65, 0.35])
    with left:
        st.markdown("### AI Teacher")
        st.caption("MAIC ¬∑ Streamlit Í∏∞Î∞ò 24/7 Q&A")
    with right:
        status = "üü¢ ÎëêÎáå Ï§ÄÎπÑÎê®" if _is_brain_ready() else "üü° ÎëêÎáå Ïó∞Í≤∞ ÎåÄÍ∏∞"
        st.markdown(f"**{status}**")
        if not _is_admin_view():
            st.button("Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏", on_click=_toggle_login_flag, use_container_width=True)
        else:
            st.caption("Í¥ÄÎ¶¨Ïûê Î™®Îìú")
    if _import_warns:
        with st.expander("ÏûÑÌè¨Ìä∏ Í≤ΩÍ≥†", expanded=False):
            for w in _import_warns: st.code(w, language="text")
    st.divider()

def _login_panel_if_needed():
    """ÌïôÏÉù ÌôîÎ©¥ÏóêÏÑúÎèÑ Ïó¥ Ïàò ÏûàÎäî Í≥†Ï†ïÌòï Î°úÍ∑∏Ïù∏ Ìå®ÎÑê(Ìó§Îçî ÏïÑÎûò)."""
    if st is None or _is_admin_view() is True:
        return
    if not st.session_state.get("_show_admin_login", False):
        return
    pwd_set = os.getenv("APP_ADMIN_PASSWORD") or _from_secrets("APP_ADMIN_PASSWORD","0000") or "0000"
    with st.container(border=True):
        st.write("### Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏")
        with st.form("admin_login_form", clear_on_submit=True):
            pwd_in = st.text_input("ÎπÑÎ∞ÄÎ≤àÌò∏", type="password")
            submitted = st.form_submit_button("Login", use_container_width=True)
        if submitted:
            if pwd_in and pwd_in == pwd_set:
                st.session_state["is_admin"] = True
                st.session_state["admin_login_ts"] = time.strftime("%Y-%m-%d %H:%M:%S")
                st.session_state["_show_admin_login"] = False
                st.success("Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ")
                st.rerun()
            else:
                st.error("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.")

# ==== [07] ÏãúÏûë Ïò§ÏºÄÏä§Ìä∏Î†àÏù¥ÏÖò(+ÏàòÎèô Î≥µÏõê Î≤ÑÌäº: Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©) =================
def _auto_start_once() -> None:
    if st is None: return
    if st.session_state.get("_auto_started"): return
    st.session_state["_auto_started"] = True

    if _is_brain_ready():  # Ïù¥ÎØ∏ Ï§ÄÎπÑÎê®
        return

    mode = (os.getenv("AUTO_START_MODE") or _from_secrets("AUTO_START_MODE","detect") or "detect").lower()
    try:
        if mode == "restore" and _gh.get("restore_latest"):
            ok = bool(_gh["restore_latest"](dest_dir=PERSIST_DIR))
            if ok: _mark_ready()
        elif mode == "full" and _rag.get("build_index_with_checkpoint"):
            _rag["build_index_with_checkpoint"](
                update_pct=lambda *_: None, update_msg=lambda *_: None,
                gdrive_folder_id=os.getenv("GDRIVE_PREPARED_FOLDER_ID","prepared"),
                gcp_creds={}, persist_dir=str(PERSIST_DIR), remote_manifest={}
            )
            _mark_ready()
        # detect Î™®Îìú: ÏàòÎèô Î≥µÏõê Î≤ÑÌäºÏúºÎ°ú Ï≤òÎ¶¨(ÏïÑÎûò), ÌïôÏÉùÏùÄ Î≤ÑÌäº ÎØ∏ÎÖ∏Ï∂ú
    except Exception as e:
        _errlog(f"AUTO_START_MODE Ïã§Ìñâ Ïò§Î•ò: {e}", where="[auto_start]", exc=e)

def _manual_restore_cta():
    """Î≥µÏõê Î≤ÑÌäºÏùÄ **Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©**. ÌïôÏÉùÏùÄ ÏïàÎÇ¥ Î¨∏Íµ¨ ÏóÜÏù¥ Ïà®ÍπÄ."""
    if st is None or _is_brain_ready() or (not _is_admin_view()):
        return
    if _gh.get("restore_latest"):
        c1, c2 = st.columns([0.72, 0.28])
        with c1:
            st.info("ÎëêÎáåÍ∞Ä ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî. ÏµúÏã† GitHub ReleasesÏóêÏÑú Î≥µÏõêÌï† Ïàò ÏûàÏñ¥Ïöî.")
        with c2:
            if st.button("ÏµúÏã† Î¶¥Î¶¨Ïä§ÏóêÏÑú Î≥µÏõê", type="primary", use_container_width=True):
                try:
                    ok = bool(_gh["restore_latest"](dest_dir=PERSIST_DIR))
                    if ok:
                        _mark_ready()
                        st.success("Î≥µÏõê ÏôÑÎ£å! Ïû†Ïãú ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®Îê©ÎãàÎã§.")
                        st.rerun()
                    else:
                        st.error("Î≥µÏõê Ïã§Ìå®: ReleasesÏùò manifest/chunksÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.")
                except Exception as e:
                    _errlog(f"manual restore failed: {e}", where="[manual_restore]", exc=e)
                    st.error(f"ÏòàÏô∏: {type(e).__name__}: {e}")

# ==== [08] ÏÑ§Î™Ö Î™®Îìú ÌóàÏö©/Í∏∞Î≥∏Í∞í: ÏòÅÏÜç ÏÑ§Ï†ï ==================================
def _modes_cfg_path() -> Path:
    return PERSIST_DIR / "explain_modes.json"

def _load_modes_cfg() -> Dict[str, Any]:
    try:
        p = _modes_cfg_path()
        if not p.exists():
            return {"allowed": ["Î¨∏Î≤ïÏÑ§Î™Ö","Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù","ÏßÄÎ¨∏Î∂ÑÏÑù"], "default": "Î¨∏Î≤ïÏÑ§Î™Ö"}
        return json.loads(p.read_text(encoding="utf-8") or "{}")
    except Exception:
        return {"allowed": ["Î¨∏Î≤ïÏÑ§Î™Ö","Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù","ÏßÄÎ¨∏Î∂ÑÏÑù"], "default": "Î¨∏Î≤ïÏÑ§Î™Ö"}

def _save_modes_cfg(cfg: Dict[str, Any]) -> None:
    try:
        p = _modes_cfg_path()
        p.write_text(json.dumps(cfg, ensure_ascii=False, indent=2), encoding="utf-8")
    except Exception as e:
        _errlog(f"save modes cfg failed: {e}", where="[modes_save]", exc=e)

def _sanitize_modes_cfg(cfg: Dict[str, Any]) -> Dict[str, Any]:
    modes = ["Î¨∏Î≤ïÏÑ§Î™Ö","Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù","ÏßÄÎ¨∏Î∂ÑÏÑù"]
    allowed = [m for m in (cfg.get("allowed") or []) if m in modes]
    if not allowed:
        allowed = []  # Ï†ÑÎ∂Ä ÎÅå ÏàòÎèÑ ÏûàÍ≤å ÌóàÏö©
    default = cfg.get("default") or "Î¨∏Î≤ïÏÑ§Î™Ö"
    if default not in modes:
        default = "Î¨∏Î≤ïÏÑ§Î™Ö"
    # defaultÍ∞Ä ÌóàÏö©ÎêòÏßÄ ÏïäÏïòÏñ¥ÎèÑ Ïú†ÏßÄ(ÌïôÏÉùÏùÄ ÏÑ†ÌÉù Î∂àÍ∞Ä ‚Üí Î≤ÑÌäº ÌöåÏÉâ)
    return {"allowed": allowed, "default": default}

# ==== [09] Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê =======================================================
def _render_admin_panels() -> None:
    if st is None or not _is_admin_view(): return
    if _ui_admin.get("ensure_admin_session_keys"): _ui_admin["ensure_admin_session_keys"]()
    if _ui_admin.get("render_admin_controls"):     _ui_admin["render_admin_controls"]()
    if _ui_admin.get("render_role_caption"):       _ui_admin["render_role_caption"]()
    st.divider()

    st.markdown("## Í¥ÄÎ¶¨Ïûê: ÏûêÎ£å/Ïù∏Îç±Ïä§ Í¥ÄÎ¶¨")
    if _ui_orch.get("render_index_orchestrator_panel"):
        try:
            _ui_orch["render_index_orchestrator_panel"]()
        except Exception as e:
            st.error(f"Ïò§ÏºÄÏä§Ìä∏Î†àÏù¥ÌÑ∞ Ìå®ÎÑê Ïò§Î•ò: {type(e).__name__}: {e}")
            _errlog(f"ui_orchestrator error: {e}", where="[admin_panel]", exc=e)
    else:
        st.info("Ïò§ÏºÄÏä§Ìä∏Î†àÏù¥ÌÑ∞ Î™®ÎìàÏù¥ ÏóÜÏäµÎãàÎã§: src.ui_orchestrator")

    st.markdown("### ÏÑ§Î™Ö Î™®Îìú ÌóàÏö© ÏÑ§Ï†ï")
    cfg = _sanitize_modes_cfg(_load_modes_cfg())
    a = set(cfg["allowed"])
    c1,c2,c3 = st.columns(3)
    with c1:  g = st.checkbox("Î¨∏Î≤ïÏÑ§Î™Ö",      value=("Î¨∏Î≤ïÏÑ§Î™Ö" in a))
    with c2:  s = st.checkbox("Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù",  value=("Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù" in a))
    with c3:  p = st.checkbox("ÏßÄÎ¨∏Î∂ÑÏÑù",      value=("ÏßÄÎ¨∏Î∂ÑÏÑù" in a))

    # Í∏∞Î≥∏ Î™®Îìú ÏÑ†ÌÉù(Í¥ÄÎ¶¨ÏûêÏö©) ‚Äî Ï†ÑÏ≤¥ Î™®Îìú Ï§ë ÏÑ†ÌÉù
    base_modes = ["Î¨∏Î≤ïÏÑ§Î™Ö","Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù","ÏßÄÎ¨∏Î∂ÑÏÑù"]
    default_sel = st.selectbox("Í∏∞Î≥∏ Î™®Îìú(ÌïôÏÉù Ï¥àÍ∏∞Í∞í)", base_modes, index=base_modes.index(cfg["default"]))

    if st.button("ÌóàÏö© ÏÑ§Ï†ï Ï†ÄÏû•", type="primary"):
        new_cfg = _sanitize_modes_cfg({"allowed": [m for m, v in [
            ("Î¨∏Î≤ïÏÑ§Î™Ö", g), ("Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù", s), ("ÏßÄÎ¨∏Î∂ÑÏÑù", p)
        ] if v], "default": default_sel})
        _save_modes_cfg(new_cfg)
        st.success("Ï†ÄÏû• ÏôÑÎ£å")
        st.rerun()

    if _ui_admin.get("render_mode_radio_admin"):
        st.markdown("#### (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©) ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© Î™®Îìú ÏÑ†ÌÉù")
        _ui_admin["render_mode_radio_admin"]()

    with st.expander("Ïò§Î•ò Î°úÍ∑∏", expanded=False):
        txt = _errlog_text()
        st.text_area("ÏµúÍ∑º Ïò§Î•ò", value=txt, height=180)
        st.download_button("Î°úÍ∑∏ Îã§Ïö¥Î°úÎìú", data=txt.encode("utf-8"), file_name="app_error_log.txt")

# ==== [10] Ï±ÑÌåÖ Ìå®ÎÑê =========================================================
def _llm_call(prompt: str, system: Optional[str] = None) -> Dict[str, Any]:
    if _llm.get("call_with_fallback"):
        return _llm["call_with_fallback"](prompt=prompt, system=system,
                                          primary="gemini", secondary="openai",
                                          temperature=0.3, max_tokens=800)
    return {"ok": False, "error": "LLM providers Î™®Îìà ÎØ∏ÌÉëÏû¨"}

def _render_mode_controls(*, admin: bool) -> str:
    """ÏÑ∏ Î™®ÎìúÎ•º Î™®Îëê Î≥¥Ïó¨Ï£ºÎêò, ÌïôÏÉùÏùÄ ÎÅà Î™®ÎìúÎäî ÎπÑÌôúÏÑ±(ÌöåÏÉâ). ÏÑ†ÌÉù Í≤∞Í≥ºÎ•º Î∞òÌôò."""
    ss = st.session_state
    cfg = _sanitize_modes_cfg(_load_modes_cfg())
    allowed = set(cfg["allowed"])
    modes = ["Î¨∏Î≤ïÏÑ§Î™Ö","Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù","ÏßÄÎ¨∏Î∂ÑÏÑù"]

    # ÌòÑÏû¨ ÏÑ†ÌÉùÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú
    cur = ss.get("qa_mode_radio") or cfg["default"]
    if (not admin) and (cur not in allowed) and allowed:
        # ÌïôÏÉùÏù¥ Í∏àÏßÄ Î™®ÎìúÏóê Î®∏Î¨ºÎü¨ ÏûàÏúºÎ©¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÍµêÏ†ï
        cur = cfg["default"]
        ss["qa_mode_radio"] = cur

    st.caption("ÏÑ§Î™Ö Î™®Îìú")
    b1,b2,b3 = st.columns(3)
    clicked = None
    for i,(col, label) in enumerate([(b1,"Î¨∏Î≤ïÏÑ§Î™Ö"),(b2,"Î¨∏Ïû•Íµ¨Ï°∞Î∂ÑÏÑù"),(b3,"ÏßÄÎ¨∏Î∂ÑÏÑù")]):
        disabled = False if admin else (label not in allowed)
        button_label = f"‚úÖ {label}" if cur == label else label
        with col:
            if st.button(button_label, use_container_width=True, disabled=disabled):
                clicked = label

    if clicked:
        ss["qa_mode_radio"] = clicked
        cur = clicked
    return cur

def _render_chat_panel() -> None:
    if st is None: return
    ss = st.session_state
    ss.setdefault("chat", [])
    ss.setdefault("_chat_next_id", 1)
    ready = _is_brain_ready()
    admin = _is_admin_view()

    with st.container(border=True):
        c1, c2 = st.columns([0.65, 0.35])
        with c1:
            st.markdown(f"**{'üü¢ ÎëêÎáå Ï§ÄÎπÑÎê®' if ready else 'üü° ÎëêÎáå Ïó∞Í≤∞ ÎåÄÍ∏∞'}**")
        with c2:
            _ = _render_mode_controls(admin=admin)

    if not ready:
        _manual_restore_cta()

    with st.container(border=True):
        for m in ss["chat"]:
            if m["role"] == "user":
                with st.chat_message("user", avatar="üßë"): st.markdown(m["text"])
            else:
                with st.chat_message("assistant", avatar="ü§ñ"): st.markdown(m["text"])

    user_q = st.chat_input("ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî")
    if not user_q: return

    msg_id = ss["_chat_next_id"]; ss["_chat_next_id"] += 1
    ss["chat"].append({"id": msg_id, "role":"user", "text": user_q})

    system_prompt = "ÎÑàÎäî ÌïúÍµ≠Ïùò ÏòÅÏñ¥ÌïôÏõê ÏõêÏû•Ï≤òÎüº, Îî∞ÎúªÌïòÍ≥† Î™ÖÌôïÌïòÍ≤å ÏÑ§Î™ÖÌïúÎã§."
    mode = ss.get("qa_mode_radio") or _sanitize_modes_cfg(_load_modes_cfg())["default"]
    prompt = f"[Î™®Îìú:{mode}]\n{user_q}"

    with st.chat_message("assistant", avatar="ü§ñ"):
        slot = st.empty()
        try:
            res = _llm_call(prompt, system_prompt)
            if res.get("ok"):
                text = (res.get("text") or "").strip()
                ss["chat"].append({"id": msg_id+1, "role":"assistant", "text": text, "provider": res.get("provider")})
                slot.markdown(text)
            else:
                slot.error(f"ÏÉùÏÑ± Ïã§Ìå®: {res.get('error')}")
                _errlog(f"LLM Ïã§Ìå®: {res.get('error')}", where="[qa_llm]")
        except Exception as e:
            slot.error(f"ÏòàÏô∏: {type(e).__name__}: {e}")
            _errlog(f"LLM ÏòàÏô∏: {e}", where="[qa_llm]", exc=e)

# ==== [11] Î≥∏Î¨∏ Î†åÎçî =========================================================
def _header_and_login():
    _header()
    _login_panel_if_needed()     # ‚Üê ÌïôÏÉù ÌôîÎ©¥ÏóêÏÑúÎèÑ Î°úÍ∑∏Ïù∏ Í∞ÄÎä•

def _render_body() -> None:
    if st is None: return
    _header_and_login()
    _auto_start_once()
    if _is_admin_view():
        _render_admin_panels()
    st.markdown("## Q&A")
    _render_chat_panel()

# ==== [12] main ==============================================================
def main():
    if st is None:
        print("Streamlit ÌôòÍ≤ΩÏù¥ ÏïÑÎãôÎãàÎã§.")
        return
    _render_body()

if __name__ == "__main__":
    main()
# =============================== [END] =======================================
